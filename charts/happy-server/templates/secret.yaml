{{- $secretName := printf "%s-secrets" (include "happy-server.fullname" .) }}
{{- $secret := lookup "v1" "Secret" .Release.Namespace $secretName }}
{{- $handyMasterSecret := "" }}
{{- if $secret }}
  {{- /* Reuse existing secret if it exists (persists across upgrades) */ -}}
  {{- $handyMasterSecret = index $secret.data "HANDY_MASTER_SECRET" }}
{{- else }}
  {{- /* Generate new random secret on first install */ -}}
  {{- $handyMasterSecret = randAlphaNum 32 | b64enc }}
{{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "happy-server.labels" . | nindent 4 }}
  annotations:
    # Prevent deletion on helm uninstall - keeps the secret for safety
    helm.sh/resource-policy: keep
type: Opaque
data:
  HANDY_MASTER_SECRET: {{ $handyMasterSecret | quote }}
